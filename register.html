<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draknor | Crear cuenta</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #0f0f12; min-height: 100vh; display: grid; place-items: center; }
    .card { border-radius: 16px; }
    .brand { font-weight: 700; letter-spacing: .5px; color: #fff; text-align:center; margin-bottom: 1rem; }
  </style>

  <!-- Fix cookies de sesión: 127.0.0.1 -> localhost -->
  <script>
    if (location.hostname === '127.0.0.1') {
      location.replace(location.href.replace('127.0.0.1', 'localhost'));
    }
  </script>
</head>
<body>
  <main class="container" style="max-width: 480px;">
    <h1 class="brand">DRAKNOR</h1>

    <div class="card shadow">
      <div class="card-body p-4">
        <h2 class="h5 mb-3">Crear cuenta</h2>

        <!-- Mantengo tus ids y estilo -->
        <form id="regForm" novalidate>
          <div class="mb-3">
            <label for="username" class="form-label">Usuario</label>
            <input type="text" class="form-control" id="username" required placeholder="tuusuario">
            <div class="invalid-feedback">Usuario requerido (3–20: letras, números, . _ -)</div>
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">Correo</label>
            <input type="email" class="form-control" id="email" required placeholder="correo@ejemplo.com">
            <div class="invalid-feedback">Correo inválido</div>
          </div>

          <div class="mb-2">
            <label for="password" class="form-label">Contraseña</label>
            <input type="password" class="form-control" id="password" required placeholder="mínimo 6 caracteres">
            <div class="invalid-feedback">La contraseña debe tener al menos 6 caracteres</div>
          </div>

          <div class="mb-2">
            <label for="password2" class="form-label">Confirmar contraseña</label>
            <input type="password" class="form-control" id="password2" required placeholder="repite la contraseña">
            <div class="invalid-feedback">Las contraseñas no coinciden</div>
          </div>

          <div id="msg" class="mt-3" aria-live="polite"></div>

          <button id="submitBtn" type="submit" class="btn btn-primary w-100 mt-3">Crear cuenta</button>
        </form>

        <hr class="my-4">
        <div class="text-center">
          <a href="login.html" class="small text-decoration-none">¿Ya tienes cuenta? Inicia sesión</a>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = (location.port === '3000') ? '' : 'http://localhost:3000';

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('regForm');
      const msg  = document.getElementById('msg');
      const btn  = document.getElementById('submitBtn');

      // Limpia estado inválido al tipear
      ['username','email','password','password2'].forEach(id => {
        document.getElementById(id).addEventListener('input', (e)=>{
          e.target.classList.remove('is-invalid');
          msg.innerHTML = '';
        });
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msg.innerHTML = '';

        const username = document.getElementById('username').value.trim();
        const email    = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const password2= document.getElementById('password2').value.trim();

        // Validaciones suaves
        const userOk = /^[a-zA-Z0-9._-]{3,20}$/.test(username);
        const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        const passOk = password.length >= 6;
        const matchOk = password === password2;

        if (!userOk) document.getElementById('username').classList.add('is-invalid');
        if (!emailOk) document.getElementById('email').classList.add('is-invalid');
        if (!passOk) document.getElementById('password').classList.add('is-invalid');
        if (!matchOk) document.getElementById('password2').classList.add('is-invalid');

        if (!userOk || !emailOk || !passOk || !matchOk) {
          msg.innerHTML = `<div class="alert alert-danger py-2 mb-0">Revisa los campos marcados.</div>`;
          (document.querySelector('.is-invalid') || document.getElementById('username')).focus();
          return;
        }

        try {
          btn.disabled = true;
          msg.innerHTML = `<div class="alert alert-info py-2 mb-0">Creando cuenta…</div>`;

          // 1) Registro
          const r = await fetch(`${API_BASE}/api/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username, email, password })
          });
          const data = await r.json();
          if (!r.ok || data?.ok === false) {
            throw new Error(data?.error || 'No se pudo registrar');
          }

          // 2) Auto-login para crear sesión y cookie
          const lg = await fetch(`${API_BASE}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username, password })
          });
          const d2 = await lg.json();
          if (!lg.ok || d2?.ok === false) {
            throw new Error('Cuenta creada, pero no se pudo iniciar sesión');
          }

          // 3) Guardar usuario en LS (del payload o de /api/me)
          let user = d2?.user;
          if (!user) {
            const me = await fetch(`${API_BASE}/api/me`, { credentials:'include' }).then(x => x.json());
            if (me?.authenticated && me.user) user = me.user;
          }
          if (user) localStorage.setItem('usuario', JSON.stringify(user));

          msg.innerHTML = `<div class="alert alert-success py-2 mb-0">Registro exitoso. Redirigiendo…</div>`;
          setTimeout(()=>{ window.location.href = 'shop.html'; }, 900);

        } catch (err) {
          msg.innerHTML = `<div class="alert alert-danger py-2 mb-0">${err.message || 'Error al registrar'}</div>`;
        } finally {
          btn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
