<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draknor | Crear cuenta</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #0f0f12; min-height: 100vh; display: grid; place-items: center; }
    .card { border-radius: 16px; }
    .brand { font-weight: 700; letter-spacing: .5px; color: #fff; text-align:center; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <main class="container" style="max-width: 480px;">
    <h1 class="brand">DRAKNOR</h1>

    <div class="card shadow">
      <div class="card-body p-4">
        <h2 class="h5 mb-3">Crear cuenta</h2>
        <form id="regForm" novalidate>
          <div class="mb-3">
            <label for="username" class="form-label">Usuario</label>
            <input type="text" class="form-control" id="username" required placeholder="tuusuario">
            <div class="invalid-feedback">Usuario requerido (3–20 caracteres: letras, números, . _ -)</div>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Correo</label>
            <input type="email" class="form-control" id="email" required placeholder="correo@ejemplo.com">
            <div class="invalid-feedback">Correo inválido</div>
          </div>
          <div class="mb-2">
            <label for="password" class="form-label">Contraseña</label>
            <input type="password" class="form-control" id="password" required placeholder="mínimo 6 caracteres">
            <div class="invalid-feedback">La contraseña debe tener al menos 6 caracteres</div>
          </div>
          <div class="mb-2">
            <label for="password2" class="form-label">Confirmar contraseña</label>
            <input type="password" class="form-control" id="password2" required placeholder="repite la contraseña">
            <div class="invalid-feedback">Las contraseñas no coinciden</div>
          </div>

          <div id="msg" class="mt-3" aria-live="polite"></div>

          <button id="submitBtn" type="submit" class="btn btn-primary w-100 mt-3">Crear cuenta</button>
        </form>

        <hr class="my-4">
        <div class="text-center">
          <a href="login.html" class="small text-decoration-none">¿Ya tienes cuenta? Inicia sesión</a>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = 'http://localhost:3000';

    const form = document.getElementById('regForm');
    const msg  = document.getElementById('msg');
    const btn  = document.getElementById('submitBtn');

    const $ = id => document.getElementById(id);

    function showAlert(type, text) {
      msg.innerHTML = `<div class="alert alert-${type} mb-0" role="alert">${text}</div>`;
    }
    function setLoading(v) {
      btn.disabled = v;
      btn.innerHTML = v
        ? `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Creando...`
        : `Crear cuenta`;
    }

    function validate() {
      let ok = true;
      const u = $('username'), e = $('email'), p = $('password'), p2 = $('password2');
      const uVal = u.value.trim();
      const eVal = e.value.trim();
      const pVal = p.value.trim();
      const p2Val = p2.value.trim();

      // usuario
      if (!/^[a-zA-Z0-9._-]{3,20}$/.test(uVal)) { u.classList.add('is-invalid'); ok = false; } else u.classList.remove('is-invalid');
      // email
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(eVal)) { e.classList.add('is-invalid'); ok = false; } else e.classList.remove('is-invalid');
      // password
      if (pVal.length < 6) { p.classList.add('is-invalid'); ok = false; } else p.classList.remove('is-invalid');
      // confirm
      if (pVal !== p2Val) { p2.classList.add('is-invalid'); ok = false; } else p2.classList.remove('is-invalid');

      return ok;
    }

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      msg.innerHTML = '';
      if (!validate()) { showAlert('danger', 'Corrige los campos marcados.'); return; }

      const payload = {
        username: $('username').value.trim(),
        email: $('email').value.trim(),
        password: $('password').value.trim()
      };

      try {
        setLoading(true);
        const r = await fetch(API_BASE + '/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // guardará cookie de sesión
          body: JSON.stringify(payload)
        });
        const j = await r.json().catch(() => ({}));

        if (!r.ok || !j.ok) {
          showAlert('danger', j.error || 'No se pudo registrar');
          setLoading(false);
          return;
        }

        showAlert('success', '¡Cuenta creada! iniciando');
        setTimeout(() => { window.location.href = 'shop.html'; }, 800);

      } catch (e) {
        showAlert('danger', 'Error de conexión con el servidor');
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
