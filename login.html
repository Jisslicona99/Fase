<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draknor | Login</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #0f0f12; min-height: 100vh; display: grid; place-items: center; }
    .card { border-radius: 16px; }
    .brand { font-weight: 700; letter-spacing: .5px; }
  </style>

  <script>
    // Redirige 127.0.0.1 -> localhost para que la cookie de sesi√≥n funcione
    if (location.hostname === '127.0.0.1') {
      location.replace(location.href.replace('127.0.0.1', 'localhost'));
    }
  </script>
</head>
<body>

  <main class="container" style="max-width: 420px;">
    <div class="mb-4 text-center text-white">
      <h1 class="brand">DRAKNOR</h1>
      <p class="mb-0 opacity-75">Inicia sesi√≥n para continuar</p>
    </div>

    <div class="card shadow">
      <div class="card-body p-4">
        <form id="loginForm" novalidate>
          <div class="mb-3">
            <label for="username" class="form-label">Usuario o Email</label>
            <input
              type="text"
              class="form-control"
              id="username"
              name="username"
              placeholder="tuusuario o correo@ejemplo.com"
              required
              autocomplete="username"
            />
            <div class="invalid-feedback">Ingresa tu usuario o Email.</div>
          </div>

          <div class="mb-2">
            <label for="password" class="form-label">Contrase√±a</label>
            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="password"
                name="password"
                placeholder="********"
                required
                autocomplete="current-password"
              />
              <button class="btn btn-outline-secondary" type="button" id="togglePwd" aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è</button>
              <div class="invalid-feedback">Ingresa tu contrase√±a.</div>
            </div>
          </div>

          <div id="msg" class="mt-3" aria-live="polite"></div>

          <button id="submitBtn" type="submit" class="btn btn-primary w-100 mt-3">
            Iniciar sesi√≥n
          </button>
        </form>

        <hr class="my-4">
        <div class="text-center">
          <a href="register.html" class="small text-decoration-none">¬øNo tienes cuenta? Crear una</a>
        </div>
      </div>
    </div>
  </main>

  <!-- JS CORREGIDO (sin cambiar estilos) -->
  <script>
    const API_BASE = (location.port === '3000') ? '' : 'http://localhost:3000';

    document.addEventListener('DOMContentLoaded', () => {
      const form   = document.getElementById('loginForm');
      const msg    = document.getElementById('msg');
      const btn    = document.getElementById('submitBtn');
      const toggle = document.getElementById('togglePwd');

      if (!form) { console.error('No se encontr√≥ #loginForm'); return; }

      // Toggle mostrar/ocultar contrase√±a
      toggle?.addEventListener('click', () => {
        const inp = document.getElementById('password');
        inp.type = (inp.type === 'password') ? 'text' : 'password';
      });

      // Limpia estado inv√°lido al escribir
      ['username','password'].forEach(id => {
        document.getElementById(id).addEventListener('input', e => {
          e.target.classList.remove('is-invalid');
          msg.innerHTML = '';
        });
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        // Validaci√≥n m√≠nima
        let ok = true;
        if (!username) { document.getElementById('username').classList.add('is-invalid'); ok = false; }
        if (!password) { document.getElementById('password').classList.add('is-invalid'); ok = false; }
        if (!ok) { msg.innerHTML = `<div class="alert alert-danger py-2 mb-0">Completa los campos requeridos.</div>`; return; }

        try {
          btn.disabled = true;
          msg.innerHTML = `<div class="alert alert-info py-2 mb-0">Validando‚Ä¶</div>`;

          const resp = await fetch(`${API_BASE}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username, password })
          });
          const data = await resp.json();

          if (!resp.ok || data?.ok === false) {
            throw new Error(data?.error || 'Usuario o contrase√±a incorrectos');
          }

          // Obtiene usuario del payload o de /api/me
          let user = data?.user;
          if (!user) {
            const me = await fetch(`${API_BASE}/api/me`, { credentials: 'include' }).then(r => r.json());
            if (me?.authenticated && me.user) user = me.user;
          }
          if (user) localStorage.setItem('usuario', JSON.stringify(user));

          msg.innerHTML = `<div class="alert alert-success py-2 mb-0">Login exitoso. Redirigiendo‚Ä¶</div>`;
          setTimeout(() => { window.location.href = 'shop.html'; }, 800);

        } catch (err) {
          msg.innerHTML = `<div class="alert alert-danger py-2 mb-0">${err.message || 'Error al iniciar sesi√≥n'}</div>`;
        } finally {
          btn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
